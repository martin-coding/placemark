{{> menu}}

<section class="section has-background-light">
  <div class="container">

    <div class="box level">
      <div class="level-left">
        <div>

          {{#if editMode}}
            <input class="input is-large mb-2" name="title" value="{{location.title}}" form="edit-location-form">
            <div class="field is-grouped">
              <div class="control">
                <div class="select is-fullwidth">
                  <select name="category" form="edit-location-form">
                    <option value="" disabled>Select Category</option>
                    <option value="hot-spring" {{#if (eq location.category "hot-spring")}}selected{{/if}}>
                      Hot spring
                    </option>
                    <option value="waterfall" {{#if (eq location.category "waterfall")}}selected{{/if}}>
                      Waterfall
                    </option>
                    <option value="glacier" {{#if (eq location.category "glacier")}}selected{{/if}}>
                      Glacier
                    </option>
                    <option value="beach" {{#if (eq location.category "beach")}}selected{{/if}}>
                      Beach
                    </option>
                  </select>
                </div>
              </div>
              <div class="control">
                <div class="select is-fullwidth">
                  <select name="visibility" form="edit-location-form">
                    <option value="" disabled>Select Visibility</option>
                    <option value="private" {{#if (eq location.visibility "private")}}selected{{/if}}>
                      private
                    </option>
                    <option value="public" {{#if (eq location.visibility "public")}}selected{{/if}}>
                      public
                    </option>
                  </select>
                </div>
              </div>
            </div>
          {{else}}
            <h1 class="title is-3">{{location.title}}</h1>
            <p class="subtitle is-6 has-text-grey">{{location.category}} · {{location.visibility}}</p>
          {{/if}}

        </div>
      </div>

      {{#if canEdit}}
      <div class="level-right">
        <div class="buttons">

          {{#if editMode}}
            <a href="/location/{{location._id}}" class="button is-danger is-outlined">Cancel</a>
            <button class="button is-success" form="edit-location-form">
              <span class="icon"><i class="fas fa-save"></i></span>
              <span>Save</span>
            </button>
          {{else}}
            <a href="/location/{{location._id}}?edit=true" class="button is-warning" data-cy="edit-location">
              <span class="icon"><i class="far fa-edit"></i></span>
              <span>Edit</span>
            </a>
          {{/if}}

        </div>
      </div>
      {{/if}}
    </div>

    <div class="columns">

      <div class="column is-5">
        <div class="card">

          <div class="card-image">
            <figure class="image is-4by3">
              {{#if location.img}}
                <img src="{{location.img}}" alt="{{location.title}}">
              {{else}}
                <div class="has-ratio is-flex is-align-items-center is-justify-content-center">
                  <p>Upload image in edit mode</p>
                </div>
              {{/if}}
            </figure>
          </div>

          {{#if editMode}}
          <div class="card-content">
            <form action="/location/{{location._id}}/uploadimage" method="POST" enctype="multipart/form-data">
              <div class="file has-name is-fullwidth">
                <label class="file-label">
                  <input class="file-input" name="imagefile" type="file" accept="image/png, image/jpeg" />
                  <span class="file-cta">
                    <span class="file-icon">
                      <i class="fas fa-upload"></i>
                    </span>
                    <span class="file-label">Choose image…</span>
                  </span>
                  <span class="file-name">No file selected</span>
                </label>
              </div>
              <button type="submit" class="button is-link is-fullwidth mt-3">Upload Image</button>
            </form>
          </div>
          {{/if}}
        </div>
      </div>

      <div class="column is-7">

        {{#if editMode}}
        <form id="edit-location-form" action="/location/{{location._id}}/update" method="POST">
        {{/if}}

           <div class="box">
              <h2 class="title is-5">Weather</h2>

              {{#if weather}}
                <div class="is-flex is-align-items-center">
                  <i class="fa-solid {{weather.icon}} mr-3" style="font-size: 2rem;"></i>

                  <div>
                    <div class="has-text-weight-semibold">
                      {{weather.temperature}}°C
                    </div>
                    <div class="is-size-7 has-text-grey">
                      Wind {{weather.windspeed}} km/h
                    </div>
                  </div>
                </div>
              {{else}}
                <p>Weather unavailable</p>
              {{/if}}

            </div>

          <div class="columns">
            <div class="column">
              <div class="box">
                <p class="heading">Latitude</p>

                {{#if editMode}}
                  <input class="input" name="latitude" value="{{location.latitude}}">
                {{else}}
                  <p class="title is-6">{{location.latitude}}</p>
                {{/if}}

              </div>
            </div>
            <div class="column">
              <div class="box">
                <p class="heading">Longitude</p>

                {{#if editMode}}
                  <input class="input" name="longitude" value="{{location.longitude}}">
                {{else}}
                  <p class="title is-6">{{location.longitude}}</p>
                {{/if}}

              </div>
            </div>
          </div>

          <div class="box">
            <h2 class="title is-5">Description</h2>

            {{#if editMode}}
              <textarea class="textarea" name="description">{{location.description}}</textarea>
            {{else}}
              <p>{{location.description}}</p>
            {{/if}}

          </div>

        {{#if editMode}}
        </form>
        {{/if}}
      </div>
    </div>

    {{#if (eq location.visibility "public") }}

    {{> review-form}}

    <div class="box">
      <h2 class="title is-5">Reviews</h2>

      {{#if reviews.length}}
        {{> list-reviews}}
      {{else}}
        <p class="has-text-grey">No reviews yet. Be the first to review this place.</p>
      {{/if}}
    </div>

    {{/if}}

    {{#if canEdit}}
    <form action="/dashboard/deletelocation/{{location._id}}" method="POST">
      <button
        type="submit"
        class="button is-danger is-light"
        onclick="return confirm('Are you sure you want to delete this location? This action cannot be undone.');"
        data-cy="delete-location">
        <span class="icon">
          <i class="fas fa-trash"></i>
        </span>
        <span>Delete Location</span>
      </button>
    </form>
    {{/if}}

  </div>
</section>

<footer class="footer">
  <div class="content has-text-centered">
    <p>
      <strong>Placemark</strong> by <a href="https://github.com/martin-coding/placemark">martin-coding</a>.
      <br>
      © 2026 Placemark
    </p>
  </div>
</footer>

<script>
  const fileInput = document.querySelector(".file-input");
  if (fileInput) {
    fileInput.onchange = () => {
      if (fileInput.files.length > 0) {
        document.querySelector(".file-name").textContent = fileInput.files[0].name;
      }
    };
  }
</script>
